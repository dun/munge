# This rpm specfile has been tested on the following systems:
# - AlmaLinux 10, 9, 8
# - CentOS Stream 9
# - Fedora 43, 42

Name:		munge
Version:	@VERSION@
Release:	1%{?dist}

# Disable test suite by default; add "--with check" to enable.
%bcond_with check

# Disable source file verification by default; add "--with verify" to enable.
# Requires a detached signature (Source1) and gpg public key (Source2).
%bcond_with verify

Summary:	MUNGE authentication service
License:	GPL-3.0-or-later
URL:		https://github.com/dun/munge
Source0:	https://github.com/dun/munge/releases/download/%{name}-%{version}/%{name}-%{version}.tar.xz
%if %{with verify}
Source1:	https://github.com/dun/munge/releases/download/%{name}-%{version}/%{name}-%{version}.tar.xz.asc
Source2:	https://github.com/dun.gpg
%endif

BuildRequires:	make
BuildRequires:	gcc
BuildRequires:	bzip2-devel
BuildRequires:	openssl-devel
BuildRequires:	zlib-devel
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}
Requires:	logrotate

BuildRequires:	systemd-rpm-macros
%{?systemd_requires}
%if 0%{?fedora} == 0 || 0%{?fedora} < 43
Requires(pre):	/usr/bin/systemd-sysusers
%endif

%if %{with check}
BuildRequires:	procps-ng
BuildRequires:	util-linux
%endif

%if %{with verify}
BuildRequires:	gpgverify
%endif

%description
MUNGE (MUNGE Uid 'N' Gid Emporium) is an authentication service for creating
and validating user credentials.  It is designed to be highly scalable for
use in an HPC cluster environment.  It provides a portable API for encoding
the user's identity into a tamper-proof credential that can be obtained by an
untrusted client and forwarded by untrusted intermediaries within a security
realm.  Clients within this realm can create and validate credentials without
the use of root privileges, reserved ports, or platform-specific methods.

%package devel
Summary:	MUNGE authentication service development files
License:	LGPL-3.0-or-later
Requires:	pkgconfig
Requires:	%{name}-libs%{?_isa} = %{version}-%{release}

%description devel
Development files for building applications that use libmunge.

%package libs
Summary:	MUNGE authentication service shared library
License:	LGPL-3.0-or-later
Requires:	%{name} = %{version}-%{release}

%description libs
The shared library (libmunge) for running applications that use MUNGE.

%prep
%if %{with verify}
%{gpgverify} --keyring='%{SOURCE2}' --signature='%{SOURCE1}' --data='%{SOURCE0}'
%endif
%setup -q

%build
%configure --disable-static \
    --with-crypto-lib=openssl \
    --with-logrotateddir=%{_sysconfdir}/logrotate.d \
    --with-pkgconfigdir=%{_libdir}/pkgconfig \
    --with-runstatedir=%{_rundir} \
    --with-systemdsysusersdir=%{_sysusersdir} \
    --with-systemdunitdir=%{_unitdir}
sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool
%make_build

%check
%if %{with check}
%make_build check \
    LD_LIBRARY_PATH=%{buildroot}%{_libdir} \
    root=/tmp/munge-test-$$ verbose=t VERBOSE=t
%endif

%install
%make_install
touch %{buildroot}%{_sysconfdir}/munge/munge.key
touch %{buildroot}%{_localstatedir}/lib/munge/munged.seed
touch %{buildroot}%{_localstatedir}/log/munge/munged.log
mkdir -p %{buildroot}%{_rundir}/munge
touch %{buildroot}%{_rundir}/munge/munged.pid

%pre
%if 0%{?fedora} == 0 || 0%{?fedora} < 43
systemd-sysusers --replace=%{_sysusersdir}/munge.conf - <<'EOF'
u munge - "MUNGE authentication service" %{_sysconfdir}/munge /usr/sbin/nologin
EOF
%endif

%post
if test ! -f %{_sysconfdir}/munge/munge.key; then
    echo "Run %{_sbindir}/mungekey as the munge user to create a key."
    echo "For example: \"sudo -u munge %{_sbindir}/mungekey -v\"."
    echo "Refer to the mungekey(8) manpage for more information."
fi
%systemd_post munge.service

%post libs -p /sbin/ldconfig

%preun
%systemd_preun munge.service

%postun
%systemd_postun_with_restart munge.service

%postun libs -p /sbin/ldconfig

%files
%license COPYING
%license COPYING.LESSER
%doc AUTHORS
%doc JARGON
%doc NEWS
%doc QUICKSTART
%doc README
%doc THANKS
%dir %attr(0700,munge,munge) %{_sysconfdir}/munge
%attr(0600,munge,munge) %config(noreplace) %ghost %{_sysconfdir}/munge/munge.key
%config(noreplace) %{_sysconfdir}/logrotate.d/munge
%config(noreplace) %{_sysconfdir}/sysconfig/munge
%dir %attr(0700,munge,munge) %{_localstatedir}/lib/munge
%attr(0600,munge,munge) %ghost %{_localstatedir}/lib/munge/munged.seed
%dir %attr(0700,munge,munge) %{_localstatedir}/log/munge
%attr(0640,munge,munge) %ghost %{_localstatedir}/log/munge/munged.log
%dir %attr(0755,munge,munge) %ghost %{_rundir}/munge
%attr(0644,munge,munge) %ghost %{_rundir}/munge/munged.pid
%{_bindir}/munge
%{_bindir}/remunge
%{_bindir}/unmunge
%{_sbindir}/munged
%{_sbindir}/mungekey
%{_mandir}/man1/munge.1*
%{_mandir}/man1/remunge.1*
%{_mandir}/man1/unmunge.1*
%{_mandir}/man7/munge.7*
%{_mandir}/man8/munged.8*
%{_mandir}/man8/mungekey.8*
%{_sysusersdir}/munge.conf
%{_unitdir}/munge.service

%files devel
%{_includedir}/munge.h
%if (0%{?rhel} && 0%{?rhel} < 10) || (0%{?fedora} && 0%{?fedora} < 36)
%{_libdir}/libmunge.la
%endif
%{_libdir}/libmunge.so
%{_libdir}/pkgconfig/munge.pc
%{_mandir}/man3/munge.3*
%{_mandir}/man3/munge_ctx.3*
%{_mandir}/man3/munge_ctx_copy.3*
%{_mandir}/man3/munge_ctx_create.3*
%{_mandir}/man3/munge_ctx_destroy.3*
%{_mandir}/man3/munge_ctx_get.3*
%{_mandir}/man3/munge_ctx_set.3*
%{_mandir}/man3/munge_ctx_strerror.3*
%{_mandir}/man3/munge_decode.3*
%{_mandir}/man3/munge_encode.3*
%{_mandir}/man3/munge_enum.3*
%{_mandir}/man3/munge_enum_int_to_str.3*
%{_mandir}/man3/munge_enum_is_valid.3*
%{_mandir}/man3/munge_enum_str_to_int.3*
%{_mandir}/man3/munge_strerror.3*

%files libs
%{_libdir}/libmunge.so.2
%{_libdir}/libmunge.so.2.0.1
